<!DOCTYPE html>
<html>
	<script>
		var enabled = false, calibration = 0, ports = {};
		function calibrate(callback){
			window.addEventListener('deviceorientation', function handleCalibrate(e){
				callback(e.beta);
				window.removeEventListener('deviceorientation', handleCalibrate);
			}, false);
		}

		function updateBadge(){
			chrome.browserAction.setBadgeText({ text: enabled ? '' : 'OFF' });
		}

		function broadcast(message){
			for (var id in ports){
				ports[id].postMessage(message);
			}
		}

		updateBadge();
		chrome.browserAction.onClicked.addListener(function(){
			enabled = !enabled;
			updateBadge();
			if (enabled){
				calibrate(function(value){
					calibration = value;
					broadcast({ enabled: true, calibration: value });
				});
			} else {
				broadcast({ enabled: false });
			}
		});
		chrome.extension.onConnect.addListener(function(port){
			ports[port.sender.tab.id] = port;
			port.postMessage({ active: port.tab.active, enabled: enabled, calibration: calibration });
			port.onDisconnect.addListener(function(){
				delete ports[port.sender.tab.id];
			});
		});
	</script>
</html>
